name: CI/CD Pipeline - OpenTelemetry Demo

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: aleemdevops
  DOCKERHUB_REPO_PREFIX: aleemdevops/opentelemetry
  ARGOCD_SERVER: a7356559de49d49c6bd04fb7f3c4b8a6-939776074.us-east-1.elb.amazonaws.com
  ARGOCD_APP: opentelemetry-demo
  K8S_CONTEXT: arn:aws:eks:us-east-1:771197743332:cluster/observability

jobs:
  build-test-push-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Login to Docker Hub
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ env.DOCKERHUB_USERNAME }}" --password-stdin

      # 3Ô∏è‚É£ Build all app images
      - name: Build Docker images
        run: |
          SERVICES="frontend checkout cart currency email payment shipping recommendation"
          for SERVICE in $SERVICES; do
            echo "üöÄ Building $SERVICE image..."
            docker build -t $DOCKERHUB_USERNAME/$SERVICE:latest ./src/$SERVICE/
          done


      # 4Ô∏è‚É£ Scan all built images with Trivy
      - name: Security scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'
          image-ref: ${{ env.DOCKERHUB_USERNAME }}/frontend:latest

      # 5Ô∏è‚É£ Push all images to Docker Hub
      - name: Push Docker images
        run: |
          SERVICES="frontend checkout cart currency email payment shipping recommendation"
          for SERVICE in $SERVICES; do
            echo "üì¶ Pushing $SERVICE to Docker Hub..."
            docker push $DOCKERHUB_USERNAME/$SERVICE:latest
          done

      # 6Ô∏è‚É£ Update Kubernetes manifests to use latest Docker Hub images
      - name: Update image paths in manifest
        run: |
          sed -i "s|ghcr.io/open-telemetry/demo:2.1.3-|${{ env.DOCKERHUB_USERNAME }}/|g" kubernetes/opentelemetry-demo.yaml

      # 7Ô∏è‚É£ Install Argo CD CLI
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd

      # 8Ô∏è‚É£ Login to ArgoCD
      - name: Login to ArgoCD
        run: |
          argocd login $ARGOCD_SERVER --username admin --password ${{ secrets.ARGOCD_PASSWORD }} --insecure

      # 9Ô∏è‚É£ Sync app on EKS cluster
      - name: Deploy latest build via ArgoCD
        run: |
          argocd app sync $ARGOCD_APP --refresh
          argocd app wait $ARGOCD_APP --health --timeout 300
